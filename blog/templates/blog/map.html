<!--
    地図上に最適な目的地、周辺情報を表示するページ
  -->
{% extends 'blog/base.html' %}
{% load static %}

{% block content %}
<div class="text1">
  <p>
    <a href="{% url 'add_route' group.pk %}">>路線選択</a>
  </p>

  <p>
    グループ番号: {{ group.pk }}<br>
  </p>

  <p>
    {% for r in route %}
    路線: {{ r }} <br>
    {% endfor %}
  </p>
</div>

  <p class="maru"><span>1</span></p>: 西武新宿駅　　　　　　
  <p class="maru"><span>2</span></p>: 都営大江戸線　新宿西口駅　
  <p class="maru"><span>3</span></p>: 都営大江戸線　新宿駅<br>
  <p class="maru"><span>4</span></p>: 副都心線　新宿三丁目駅
  <p class="maru"><span>5</span></p>: 丸ノ内線　新宿駅　　　　　
  <p class="maru"><span>6</span></p>: 丸ノ内線　新宿三丁目駅<br>
  <p class="maru"><span>7</span></p>: 都営新宿線　新宿駅　　
  <p class="maru"><span>8</span></p>: 都営新宿線　新宿三丁目駅　
  <p class="maru"><span>9</span></p>: JR線　新宿駅<br>
  <p class="maru"><span>10</span></p>: 京王線　新宿駅　　　　
  <p class="maru"><span>11</span></p>: 京王新線　新宿駅　　　　　
  <p class="maru"><span>12</span></p>: 小田急線　新宿駅<br>

  <img src="{% static "img/icon/gate.png"%}"/ style="padding-bottom: 2px">:改札　　
  <img src="{% static "img/icon/stairs.png"%}"/ style="padding-bottom: 2px"> :階段　　
  <img src="{% static "img/icon/escalator.png"%}"/ style="padding-bottom: 2px"> :エスカレーター　
  <img src="{% static "img/icon/elevator.png"%}"/ style="padding-bottom: 2px"> :エレベーター　
  <img src="{% static "img/icon/police.png"%}"/ style="padding-bottom: 2px"> :警察　
  <img src="{% static "img/icon/toilet.png"%}"/ style="padding-bottom: 2px"> :トイレ
  <br><br>


<style>
  .maru{
   text-align:center;
   line-height: 22px;
   font-weight:bold;
   vertical-align: middle;
   display: inline-block;
   border-radius: 22px;
   margin: 4px;
   width: 22px;
   height: 22px;
   background-color:  #F6C03E;
  }
  .line{
  display: inline-block;
  vertical-align: bottom;

</style>


<p>
  <button type="button" onclick="changeMeetPoint(1)" style="width:100px;height:80px"><font size="5">案1</font></button>
  <button type="button" onclick="changeMeetPoint(2)" style="width:100px;height:80px"><font size="5">案2</font></button>
</p>


<p>
  <button type="button" onclick="changeLayer('/1F')" style="width:100px;height:80px"><font size="5">地上階</font></button>
  <button type="button" onclick="changeLayer('/B1')" style="width:100px;height:80px"><font size="5">B1</font></button>
  <button type="button" onclick="changeLayer('/B2')" style="width:100px;height:80px"><font size="5">B2</font></button>
  <button type="button" onclick="changeLayer('/B3')" style="width:100px;height:80px"><font size="5">B3</font></button>
</p>



<div id="mapcontainer" style="width:900px;height:900px"></div>
<script>

  /*----------地図表示---------*/
  var map = L.map("mapcontainer", {
  crs: L.CRS.Simple,
  minZoom: 0,
  maxZoom: 2,
  });

  //地図の中心座標とズームレベルを指定。
  //0が最小、2が最大ズーム
  map.setView(L.latLng(-1000/2, 1000/2), 0);

  //地図を表示。(画像がある場所のパスを指定しています。この通りでないと表示できないので注意。)
  tile = L.tileLayer("{% static 'nodemap2' %}" + "/1F/{z}/{x}/{y}.png", {
    tileSize: 1000,
    attribution: "<a>自作タイル</a>",
  }).addTo(map);

  /*-----ノード上にマーカーを配置する-----*/

  //マーカーを階層別にグループわけする。1F~B3のノードとother(改札)
  var markerList_all = L.featureGroup();
  var markerList_idea1 = L.featureGroup();
  var markerList_idea2 = L.featureGroup();

  //マーカー用画像の指定
  var blueIcon = L.icon({
    iconUrl: "{% static 'img/icon' %}" + '/blue.png',
    iconSize: [34,55],
    iconAnchor: [17,55],
    iconRetinaUrl: "{% static 'img/icon' %}" + '/blue_2x.png',
  });
  var greenIcon = L.icon({
    iconUrl: "{% static 'img/icon' %}" + '/greenIcon.png',
    iconSize: [25,41],
    iconAnchor: [12.5,41],
    iconRetinaUrl: "{% static 'img/icon' %}" + '/greenIcon_2x.png',
  });
  var redIcon = L.icon({
    iconUrl: "{% static 'img/icon' %}" + '/redIcon.png',
    iconSize: [25,41],
    iconAnchor: [12.5,41],
    iconRetinaUrl: "{% static 'img/icon' %}" + '/redIcon_2x.png',
  });
  var purpleIcon = L.icon({
    iconUrl: "{% static 'img/icon' %}" + '/purpleIcon.png',
    iconSize: [25,41],
    iconAnchor: [12.5,41],
    iconRetinaUrl: "{% static 'img/icon' %}" + '/purpleIcon_2x.png',
  });
  var yellowIcon = L.icon({
    iconUrl: "{% static 'img/icon' %}" + '/yellowIcon.png',
    iconSize: [25,41],
    iconAnchor: [12.5, 41],
    iconRetinaUrl: "{% static 'img/icon' %}" + '/yellowIcon_2x.png',
  });
  var hereIcon = L.icon({
    iconUrl: "{% static 'img/icon' %}" + '/hereIcon.png',
    iconSize: [60,95],
    iconAnchor: [30,95],
    iconRetinaUrl: "{% static 'img/icon' %}" + '/hereIcon_2x.png',
  });

  //全ノード番号と座標データを格納するリスト
  var result = [];

  //案1と2の待ち合わせ場所ノード番号をそれぞれ格納
  var markList1 = {{ meet.0 }};
  var markList2 = {{ meet.1 }};

  //案1と2の待ち合わせ場所の[y座標, x座標, 画像のソース, 階層]の欲張りセットを格納する。
  var pointList_idea1 = [];
  var pointList_idea2 = [];


  function getCSV(){
      var req = new XMLHttpRequest(); // HTTPでファイルを読み込むためのXMLHttpRrequestオブジェクトを生成
      req.open("get", "{% static 'nodemap2' %}" + "/nodenumber.csv", true); // アクセスするファイルを指定
      req.send(null); // HTTPリクエストの発行

      // レスポンスが返ってきたらconvertCSVtoArray()を呼ぶ
      req.onload = function(){
  	     convertCSVtoArray(req.responseText); // 渡されるのは読み込んだCSVデータ
      }
  }

  //読み込んだCSVデータが文字列として渡される
  function convertCSVtoArray(str){
    var tmp = str.split("\n"); // 改行を区切り文字として行を要素とした配列を生成

    for(var i=0;i<tmp.length;++i){
        result[i] = tmp[i].split(',');

        switch (result[i][3] - 0) {
          case 0:
            {% for r in routes %}
              if (result[i][0] == {{ r.route }} - 0) {
                //markerList_idea1.addLayer(L.marker([result[i][1], result[i][2]], {icon: blueIcon}));
                //markerList_idea2.addLayer(L.marker([result[i][1], result[i][2]], {icon: blueIcon}));
                L.marker([result[i][1], result[i][2]], {icon: blueIcon}).addTo(map);
                break;
              }
            {% endfor %}
            break;
          case 1:
            search_and_add(i);
            //markerList_all.addLayer(L.marker([result[i][1], result[i][2]], {title: result[i][0], icon: orangeIcon}).bindPopup(result[i][0]));
            break;
          case 2:
            search_and_add(i);
            //markerList_all.addLayer(L.marker([result[i][1], result[i][2]]).bindPopup(result[i][0]));
            break;
          case 3:
            search_and_add(i);
            //markerList_all.addLayer(L.marker([result[i][1], result[i][2]], {title: result[i][0], icon: greenIcon}).bindPopup(result[i][0]));
            break;
          case 4:
            search_and_add(i);
            //markerList_all.addLayer(L.marker([result[i][1], result[i][2]], {title: result[i][0], icon: greenIcon}).bindPopup(result[i][0]));
            break;
          default:
            break;
        }
    }
  }


  //------マーカーのグループ分け作業用関数 アンケート時は案1の待ち合わせ場所のみを調べる。
  function search_and_add(i) {
    for (var a=0; a<markList1.length; a++) {
      if (result[i][0] == markList1[a]) {
        var content1 = "";
        if (result[i][0] - 0 == 213 || result[i][0] - 0 >= 1000) {
          content1 = result[i][4] + "<br><img src='{% static 'img/point/' %}" + result[i][0] + ".jpg'>";
        } else  {
          content1 = result[i][4] + "<br>画像はありません";
        }
        var popup = L.popup({ maxWidth:800, maxHeight:800 });
        popup.setContent(content1);
        markerList_idea1.addLayer(L.marker([result[i][1], result[i][2]], {icon: hereIcon}).bindPopup(popup).openPopup());
        break;
      }
    }

    for (var a=0; a<markList2.length; a++) {
      if (result[i][0] == markList2[a]) {
        var content2 = "";
        if (result[i][0] - 0 == 213 || result[i][0] - 0 >= 1000) {
          content2 = result[i][4]+"<br><img src='{% static 'img/point/' %}" + result[i][0] + ".jpg'>";
        } else  {
          content2 = result[i][4] + "<br>画像はありません";
        }
        var popup2 = L.popup({ maxWidth:800, maxHeight:800 });
        popup2.setContent(content2);
        markerList_idea2.addLayer(L.marker([result[i][1], result[i][2]], {icon: hereIcon}).bindPopup(popup).openPopup());
        break;
      }
    }
  }


  //上の方に書いてあるgetCSV関数を呼び出して処理実行。
  getCSV();

  map.addLayer(markerList_idea1);

  //タイル差し替え関数
  function changeLayer(place) {
    tile.setUrl("{% static 'nodemap2' %}" + place + "/{z}/{x}/{y}.png");
  }

  function changeMeetPoint(number) {
    if (number == 1) {
      map.addLayer(markerList_idea1.openPopup());
      map.removeLayer(markerList_idea2);
    } else if (number == 2) {
      map.addLayer(markerList_idea2.openPopup());
      map.removeLayer(markerList_idea1);
    }
  }

</script>
{% endblock %}
